<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš€ Krypto Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        /* FÃ¼gen Sie hier Ihr vollstÃ¤ndiges CSS von vorhin ein */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* etc. */ }
    </style>
</head>
<body>
    <script>
        // --- KONFIGURATION ---
        const GOOGLE_SHEET_CSV_URL = "IHREN_GOOGLE_SHEET_CSV_EXPORT_LINK_HIER_EINFÃœGEN";

        // === HILFSFUNKTIONEN (MÃœSSEN ZUERST DEFINIERT WERDEN) ===
        function parseGermanNumber(str) {
            if (typeof str !== 'string' || !str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        }

        // ... (Ihre loadUserSettings und saveUserSettings Funktionen hier einfÃ¼gen) ...

        // === DATENVERARBEITUNG (NEU & KORRIGIERT) ===

        function processSheetData(data) {
            console.log('ðŸ”„ Starte Datenverarbeitung...');
            const coins = {};
            
            // 1. Alle Daten nach Coin gruppieren
            data.forEach(row => {
                const coinName = row["Coin"];
                if (!coinName) return;
                if (!coins[coinName]) {
                    coins[coinName] = { rawData: [] };
                }
                coins[coinName].rawData.push(row);
            });

            const portfolioHistoryMap = new Map();
            let totalPortfolioValue = 0;

            // 2. FÃ¼r jeden Coin: Den neuesten Eintrag finden und historische Daten fÃ¼r Charts vorbereiten
            for (const coinName in coins) {
                const coin = coins[coinName];
                
                // Sortiere alle EintrÃ¤ge fÃ¼r diesen Coin nach Datum, neueste zuerst
                coin.rawData.sort((a, b) => new Date(b.Datum) - new Date(a.Datum));
                
                // Der neueste Eintrag ist der erste in der sortierten Liste
                const latestEntry = coin.rawData[0];
                if (latestEntry) {
                    const latestValue = parseGermanNumber(latestEntry.Wert_EUR);
                    totalPortfolioValue += latestValue;
                    console.log(`ðŸ’° ${coinName}: Neuester Wert ist â‚¬${latestValue.toFixed(2)} (vom ${latestEntry.Datum})`);
                }

                // FÃ¼r die Charts, sortiere wieder chronologisch (Ã¤lteste zuerst)
                coin.rawData.sort((a, b) => new Date(a.Datum) - new Date(b.Datum));

                // Extrahiere Chart-Daten
                coin.dates = coin.rawData.map(r => r.Datum);
                coin.prices = coin.rawData.map(r => parseGermanNumber(r.Preis_EUR));
                coin.rsi = coin.rawData.map(r => parseFloat(r.RSI));
                // FÃ¼gen Sie hier weitere Indikatoren fÃ¼r Charts hinzu...
            }
            
            // 3. Portfolio-Historie fÃ¼r den Chart korrekt berechnen
            data.forEach(row => {
                const dateKey = row.Datum.split(' ')[0];
                const wert = parseGermanNumber(row.Wert_EUR);
                const currentTotal = portfolioHistoryMap.get(dateKey) || 0;
                portfolioHistoryMap.set(dateKey, currentTotal + wert);
            });

            const portfolioHistory = Array.from(portfolioHistoryMap.entries())
                .map(([date, value]) => ({ date, value }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            console.log(`âœ… Verarbeitung abgeschlossen. Finaler Portfolio-Wert: â‚¬${totalPortfolioValue.toFixed(2)}`);
            
            return {
                coins: coins,
                last_update: new Date().toISOString(),
                portfolio_total: totalPortfolioValue,
                portfolio_history: portfolioHistory
            };
        }

        // === DATENLADUNG & INITIALISIERUNG ===
        document.addEventListener('DOMContentLoaded', () => {
            // ... (Ihre setupEventListeners Funktion hier einfÃ¼gen) ...
            loadDataFromSheet();
        });

        function loadDataFromSheet() {
            // ... (Ihre loadDataFromSheet Funktion von vorhin, die KEINEN Demo-Fallback hat) ...
        }

        function parseCSV(csvText) {
            // ... (Ihre parseCSV Funktion von vorhin) ...
        }
        
        function initializeDashboard() {
            // ... (Ihre UI-Initialisierungs-Logik) ...
        }

        // === FÃ¼gen Sie hier alle weiteren UI-Update-Funktionen (updateDashboard, updateKPIs, updateCharts etc.) ein ===
    </script>
</body>
</html>
